-- Bảng 1: patients (Quản lý Khách hàng / Bệnh nhân) [1-3]
CREATE TABLE patients (
    patient_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    full_name VARCHAR(255) NOT NULL,
    phone_number VARCHAR(20) UNIQUE,
    date_of_birth DATE,
    gender VARCHAR(10),
    is_b2b_customer BOOLEAN DEFAULT FALSE, -- Phân biệt Khách lẻ/Bệnh nhân và Khách buôn [4]
    loyalty_points INTEGER DEFAULT 0,
    allergy_notes TEXT, -- Dị ứng đã biết [5, 6]
    chronic_diseases TEXT, -- Bệnh nền/Bệnh mãn tính [6-8]
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Bảng 2: employees (Quản lý Nhân sự - Bác sĩ, Dược sĩ, Lễ tân) [9, 10]
CREATE TABLE employees (
    employee_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    full_name VARCHAR(255) NOT NULL,
    employee_code VARCHAR(50) UNIQUE,
    role_name VARCHAR(50) NOT NULL, -- Ví dụ: 'BacSi', 'DuocSi', 'LeTan' [11-13]
    is_active BOOLEAN DEFAULT TRUE
);



II. Các Bảng Cho Module Đặt Lịch Hẹn (Appointments)
Bảng này quản lý quy trình Đặt lịch hẹn và các trạng thái liên quan, là bước khởi đầu của luồng Nghiệp vụ Y tế.
-- Bảng 4: appointment_statuses (Bảng tra cứu Trạng thái Lịch hẹn) [24, 25]
CREATE TABLE appointment_statuses (
    status_code VARCHAR(20) PRIMARY KEY,
    status_name_vn VARCHAR(50) NOT NULL,
    color_code VARCHAR(10) -- Mã hóa màu sắc trên Dashboard [24, 25]
);

-- Bảng 5: appointments (Chi tiết các Lịch hẹn) [12, 25-30]
CREATE TABLE appointments (
    appointment_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    patient_id UUID NOT NULL REFERENCES patients(patient_id),
    service_type VARCHAR(50), -- Khám Bệnh | Tiêm Chủng | Siêu âm [29]
    scheduled_datetime TIMESTAMP WITH TIME ZONE NOT NULL,
    doctor_id UUID REFERENCES employees(employee_id), -- Bác sĩ/Tài nguyên được đặt lịch [27]
    receptionist_id UUID REFERENCES employees(employee_id), -- Lễ tân tạo lịch
    current_status VARCHAR(20) NOT NULL REFERENCES appointment_statuses(status_code), -- Xám, Xanh Lá, Tím, v.v. [24, 25]
    reason_for_visit TEXT,
    check_in_time TIMESTAMP WITH TIME ZONE, -- Thời gian Lễ tân Check-in [31]
    is_confirmed_by_zalo BOOLEAN DEFAULT FALSE, -- Đã gửi SMS/Zalo xác nhận [29]
    receptionist_notes TEXT, -- Ghi chú Lễ tân: "Bệnh nhân VIP", "Thường xuyên đến trễ" [32]
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
III. Các Bảng Cho Module Phòng Khám (Clinic)
Các bảng này lưu trữ Hồ sơ Bệnh án Điện tử (EMR) và các y lệnh của Bác sĩ, tuân thủ mô hình SOAP.
-- Bảng 6: medical_visits (Hồ sơ lần Khám Bệnh - EMR) [1, 5, 7, 13, 16, 33-54]
CREATE TABLE medical_visits (
    visit_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    appointment_id UUID UNIQUE REFERENCES appointments(appointment_id), -- Liên kết với lịch hẹn
    patient_id UUID NOT NULL REFERENCES patients(patient_id),
    doctor_id UUID NOT NULL REFERENCES employees(employee_id),
    visit_date TIMESTAMP WITH TIME ZONE DEFAULT now(),
    subjective_notes TEXT, -- Phần S: Bệnh sử [38]
    objective_notes TEXT, -- Phần O: Thăm khám thực thể [40]
    vital_signs JSONB, -- Dấu hiệu sinh tồn (Nhiệt độ, HA, Mạch) [41]
    assessment_diagnosis_icd10 VARCHAR(50), -- Phần A: Mã ICD-10 [43]
    plan_notes TEXT, -- Phần P: Kế hoạch xử trí chung [37]
    is_signed_off BOOLEAN DEFAULT FALSE, -- Đã Hoàn tất & Ký số [34]
    signed_off_at TIMESTAMP WITH TIME ZONE
);

-- Bảng 7: lab_orders (Chỉ định Cận lâm sàng/Xét nghiệm) [46, 50]
CREATE TABLE lab_orders (
    order_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    visit_id UUID NOT NULL REFERENCES medical_visits(visit_id),
    service_name VARCHAR(255) NOT NULL, -- Tên dịch vụ: X-Quang, Công thức máu [47]
    preliminary_diagnosis TEXT, -- Chẩn đoán sơ bộ (quan trọng cho phòng ban khác) [49]
    is_executed BOOLEAN DEFAULT FALSE, -- Đã thực hiện
    result_received_at TIMESTAMP WITH TIME ZONE -- Thời gian nhận kết quả (để gửi vào Hộp thư Kết quả) [55]
);

-- Bảng 8: prescriptions (Chi tiết Đơn thuốc điện tử) [16, 35, 56]
CREATE TABLE prescriptions (
    prescription_item_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    visit_id UUID NOT NULL REFERENCES medical_visits(visit_id),
    product_id UUID NOT NULL REFERENCES products(product_id), -- Thuốc được kê
    quantity_ordered INTEGER NOT NULL,
    dosage_instruction TEXT, -- Hướng dẫn sử dụng: 'Ngày 2 lần, mỗi lần 1 viên sau ăn' [56]
    ai_interaction_warning TEXT -- Cảnh báo Tương tác Thuốc từ AI [16]
);
IV. Bảng Cho Module Bán Hàng POS và Tích Hợp
Bảng này quản lý giao dịch bán hàng cuối cùng, bao gồm cả bán lẻ (POS) và chi phí dịch vụ phát sinh từ phòng khám.
-- Bảng 9: sales_orders (Đơn hàng bán lẻ/POS) [57-59]
CREATE TABLE sales_orders (
    order_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    patient_id UUID REFERENCES patients(patient_id), -- Khách hàng mua
    medical_visit_id UUID UNIQUE REFERENCES medical_visits(visit_id), -- Đơn hàng được tạo từ lần khám [56, 60]
    order_type VARCHAR(20) NOT NULL, -- 'POS', 'B2B', 'TMDT' [35]
    created_by_employee_id UUID REFERENCES employees(employee_id),
    order_datetime TIMESTAMP WITH TIME ZONE DEFAULT now(),
    total_value DECIMAL(18, 2) NOT NULL,
    payment_method VARCHAR(50), -- Tiền mặt, Thẻ, Chuyển khoản [61]
    payment_status VARCHAR(20), -- Đã thanh toán, Thanh toán thiếu, Chờ thanh toán [62, 63]
    operational_status VARCHAR(20) NOT NULL, -- Hoàn tất, Đã hủy [62]
    is_ai_checked BOOLEAN DEFAULT FALSE -- Đã được AI Kiểm tra tương tác thuốc/tính ngày dùng thuốc [64]
);

-- Bảng 10: sales_order_items (Chi tiết sản phẩm trong đơn hàng) [56]
CREATE TABLE sales_order_items (
    item_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    order_id UUID NOT NULL REFERENCES sales_orders(order_id),
    product_id INTEGER NOT NULL REFERENCES products(product_id),
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(18, 2),
    is_service BOOLEAN DEFAULT FALSE, -- Phân biệt sản phẩm vật lý và phí dịch vụ (Phí khám)
    dosage_printed TEXT -- Hướng dẫn sử dụng in ra bill K80 [65, 66]
);